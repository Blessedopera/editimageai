<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Editor</title>
    <style>
    * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    }

    body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px;
    }

    .container {
    max-width: 1200px;
    margin: 0 auto;
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    overflow: hidden;
    }

    .header {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
    padding: 40px;
    text-align: center;
    position: relative;
    }

    .header h1 {
    font-size: 2.5rem;
    margin-bottom: 10px;
    font-weight: 700;
    }

    .header p {
    font-size: 1.1rem;
    opacity: 0.9;
    }

    .user-info {
    position: absolute;
    top: 20px;
    right: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    }

    .credits-display {
    background: rgba(255,255,255,0.2);
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 600;
    }

    .user-menu {
    position: relative;
    }

    .user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255,255,255,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-weight: bold;
    }

    .dropdown-menu {
    position: absolute;
    top: 50px;
    right: 0;
    background: white;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    min-width: 200px;
    display: none;
    z-index: 1000;
    }

    .dropdown-menu.show {
    display: block;
    }

    .dropdown-item {
    padding: 12px 20px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    color: #333;
    }

    .dropdown-item:hover {
    background: #f8f9fa;
    }

    .dropdown-item:last-child {
    border-bottom: none;
    }

    .auth-section {
    display: none;
    padding: 40px;
    text-align: center;
    }

    .auth-section.show {
    display: block;
    }

    .auth-tabs {
    display: flex;
    justify-content: center;
    margin-bottom: 30px;
    }

    .auth-tab {
    padding: 12px 30px;
    background: #f8f9fa;
    border: none;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    }

    .auth-tab.active {
    background: #4facfe;
    color: white;
    }

    .auth-tab:first-child {
    border-radius: 10px 0 0 10px;
    }

    .auth-tab:last-child {
    border-radius: 0 10px 10px 0;
    }

    .auth-form {
    max-width: 400px;
    margin: 0 auto;
    }

    .form-group {
    margin-bottom: 20px;
    text-align: left;
    }

    .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid #e1e5e9;
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
    outline: none;
    border-color: #4facfe;
    }

    .form-group textarea {
    resize: vertical;
    min-height: 100px;
    font-family: inherit;
    }

    .auth-btn {
    width: 100%;
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 10px;
    font-size: 18px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 10px;
    }

    .auth-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
    }

    .auth-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
    }

    .main-content {
    display: none;
    grid-template-columns: 1fr 1fr;
    gap: 40px;
    padding: 40px;
    }

    .main-content.show {
    display: grid;
    }

    .upload-section {
    background: #f8f9fa;
    border-radius: 15px;
    padding: 30px;
    }

    .upload-area {
    border: 3px dashed #4facfe;
    border-radius: 15px;
    padding: 40px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
    }

    .upload-area:hover {
    border-color: #00f2fe;
    background: #f0f9ff;
    }

    .upload-area.dragover {
    border-color: #00f2fe;
    background: #e0f2fe;
    }

    .upload-icon {
    font-size: 3rem;
    color: #4facfe;
    margin-bottom: 20px;
    }

    .generate-btn {
    width: 100%;
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 10px;
    font-size: 18px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 20px;
    }

    .generate-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
    }

    .generate-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
    }

    .result-section {
    text-align: center;
    }

    .result-area {
    background: #f8f9fa;
    border-radius: 15px;
    padding: 30px;
    min-height: 400px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    }

    .result-image {
    max-width: 100%;
    max-height: 500px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .loading {
    display: none;
    flex-direction: column;
    align-items: center;
    }

    .spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #4facfe;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
    }

    @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
    }

    .error {
    color: #e74c3c;
    background: #fdf2f2;
    padding: 15px;
    border-radius: 8px;
    margin-top: 15px;
    border-left: 4px solid #e74c3c;
    }

    .success {
    color: #27ae60;
    background: #f0f9f4;
    padding: 15px;
    border-radius: 8px;
    margin-top: 15px;
    border-left: 4px solid #27ae60;
    }

    .download-btn {
    background: #27ae60;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 20px;
    transition: all 0.3s ease;
    }

    .download-btn:hover {
    background: #219a52;
    transform: translateY(-2px);
    }

    .preview-image {
    max-width: 200px;
    max-height: 200px;
    border-radius: 10px;
    margin-top: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .dashboard-section {
    display: none;
    padding: 40px;
    }

    .dashboard-section.show {
    display: block;
    }

    .dashboard-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-bottom: 40px;
    }

    .dashboard-card {
    background: #f8f9fa;
    border-radius: 15px;
    padding: 30px;
    text-align: center;
    }

    .dashboard-card h3 {
    color: #333;
    margin-bottom: 15px;
    font-size: 1.5rem;
    }

    .dashboard-card .number {
    font-size: 3rem;
    font-weight: bold;
    color: #4facfe;
    margin-bottom: 10px;
    }

    .buy-credits-btn {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 10px;
    font-size: 18px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 20px;
    }

    .buy-credits-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
    }

    .modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    }

    .modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
    }

    .modal-content {
    background: white;
    border-radius: 20px;
    padding: 40px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
    }

    .modal-close {
    position: absolute;
    top: 15px;
    right: 20px;
    font-size: 30px;
    cursor: pointer;
    color: #999;
    }

    .modal-close:hover {
    color: #333;
    }

    .credit-plans {
    display: grid;
    gap: 20px;
    margin-top: 20px;
    }

    .credit-plan {
    border: 2px solid #e1e5e9;
    border-radius: 15px;
    padding: 25px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    }

    .credit-plan:hover {
    border-color: #4facfe;
    background: #f0f9ff;
    }

    .credit-plan.selected {
    border-color: #4facfe;
    background: #f0f9ff;
    }

    .credit-plan h4 {
    font-size: 1.5rem;
    margin-bottom: 10px;
    color: #333;
    }

    .credit-plan .price {
    font-size: 2rem;
    font-weight: bold;
    color: #4facfe;
    margin-bottom: 10px;
    }

    .credit-plan .credits {
    font-size: 1.2rem;
    color: #666;
    margin-bottom: 15px;
    }

    .credit-plan .value {
    background: #27ae60;
    color: white;
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 0.9rem;
    display: inline-block;
    }

    .purchase-btn {
    width: 100%;
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 10px;
    font-size: 18px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 30px;
    }

    .purchase-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
    }

    .purchase-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
    }

    .history-section {
    margin-top: 40px;
    }

    .history-item {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .history-image {
    width: 80px;
    height: 80px;
    border-radius: 10px;
    object-fit: cover;
    }

    .history-details {
    flex: 1;
    }

    .history-date {
    color: #666;
    font-size: 0.9rem;
    }

    .history-params {
    color: #333;
    margin-top: 5px;
    }

    @media (max-width: 768px) {
    .main-content {
    grid-template-columns: 1fr;
    gap: 20px;
    padding: 20px;
    }

    .dashboard-grid {
    grid-template-columns: 1fr;
    }

    .header h1 {
    font-size: 2rem;
    }

    .user-info {
    position: static;
    justify-content: center;
    margin-top: 20px;
    }
    }
    </style>
</head>
<body>
    <div class="container">
    <div class="header">
    <h1>🎨 AI Image Editor</h1>
    <p>Transform any image using natural language prompts with advanced AI</p>

    <div class="user-info" id="userInfo" style="display: none;">
    <div class="credits-display" id="creditsDisplay">
    💎 <span id="creditsCount">0</span> Credits
    </div>
    <div class="user-menu">
    <div class="user-avatar" id="userAvatar" onclick="toggleUserMenu()">
    U
    </div>
    <div class="dropdown-menu" id="userDropdown">
    <div class="dropdown-item" onclick="showDashboard()">📊 Dashboard</div>
    <div class="dropdown-item" onclick="showGenerator()">🎨 Editor</div>
    <div class="dropdown-item" onclick="showBuyCredits()">💎 Buy Credits</div>
    <div class="dropdown-item" onclick="logout()">🚪 Logout</div>
    </div>
    </div>
    </div>
    </div>

    <!-- Authentication Section -->
    <div class="auth-section show" id="authSection">
    <div class="auth-tabs">
    <button class="auth-tab active" onclick="showLogin()">Login</button>
    <button class="auth-tab" onclick="showSignup()">Sign Up</button>
    </div>

    <!-- Login Form -->
    <div class="auth-form" id="loginForm">
    <h2>Welcome Back!</h2>
    <p style="margin-bottom: 30px; color: #666;">Sign in to your account to continue</p>

    <div class="form-group">
    <label for="loginEmail">Email</label>
    <input type="email" id="loginEmail" placeholder="Enter your email" required>
    </div>

    <div class="form-group">
    <label for="loginPassword">Password</label>
    <input type="password" id="loginPassword" placeholder="Enter your password" required>
    </div>

    <button class="auth-btn" onclick="login()">Sign In</button>
    <div id="loginMessage"></div>
    </div>

    <!-- Signup Form -->
    <div class="auth-form" id="signupForm" style="display: none;">
    <h2>Create Account</h2>
    <p style="margin-bottom: 30px; color: #666;">Join us and get 10 free credits!</p>

    <div class="form-group">
    <label for="signupName">Full Name</label>
    <input type="text" id="signupName" placeholder="Enter your full name">
    </div>

    <div class="form-group">
    <label for="signupEmail">Email</label>
    <input type="email" id="signupEmail" placeholder="Enter your email" required>
    </div>

    <div class="form-group">
    <label for="signupPassword">Password</label>
    <input type="password" id="signupPassword" placeholder="Create a password" required>
    </div>

    <button class="auth-btn" onclick="signup()">Create Account</button>
    <div id="signupMessage"></div>
    </div>
    </div>

    <!-- Dashboard Section -->
    <div class="dashboard-section" id="dashboardSection">
    <h2>📊 Dashboard</h2>

    <div class="dashboard-grid">
    <div class="dashboard-card">
    <h3>Available Credits</h3>
    <div class="number" id="dashboardCredits">0</div>
    <p>Use credits to generate headshots</p>
    <button class="buy-credits-btn" onclick="showBuyCredits()">Buy More Credits</button>
    </div>

    <div class="dashboard-card">
    <h3>Total Edited</h3>
    <div class="number" id="totalGenerated">0</div>
    <p>Images edited with AI</p>
    </div>
    </div>

    <div class="history-section">
    <h3>Recent Edits</h3>
    <div id="historyList">
    <p style="text-align: center; color: #666; padding: 40px;">No images edited yet. Start creating!</p>
    </div>
    </div>
    </div>

    <!-- Main Generator Section -->
    <div class="main-content" id="mainContent">
    <div class="upload-section">
    <h2>Upload Your Image</h2>
    <form id="imageEditForm" enctype="multipart/form-data">
    <div class="upload-area" id="uploadArea">
    <div class="upload-icon">📸</div>
    <h3>Drop your image here or click to browse</h3>
    <p>Supports JPG, PNG, WebP, GIF (max 10MB)</p>
    <input type="file" id="imageInput" name="image" accept="image/*" style="display: none;">
    </div>
    <div id="imagePreview"></div>

    <div class="form-group">
    <label for="prompt">Edit Prompt</label>
    <textarea id="prompt" name="prompt" placeholder="Describe how you want to edit the image (e.g., 'Make this a 90s cartoon', 'Change the background to a beach', 'Make it black and white')" rows="4" required></textarea>
    </div>

    <div class="form-group">
    <label for="outputFormat">Output Format</label>
    <select id="outputFormat" name="outputFormat">
    <option value="jpg">JPEG</option>
    <option value="png">PNG</option>
    <option value="webp">WebP</option>
    </select>
    </div>

    <button type="submit" class="generate-btn" id="generateBtn">
    Edit Image (1 Credit)
    </button>
    </form>
    </div>

    <div class="result-section">
    <h2>Your Edited Image</h2>
    <div class="result-area" id="resultArea">
    <div class="loading" id="loading">
    <div class="spinner"></div>
    <p>Editing your image...</p>
    <p><small>This may take 10-30 seconds</small></p>
    </div>
    <div id="resultContent">
    <p>Your edited image will appear here</p>
    </div>
    </div>
    </div>
    </div>

    <!-- Buy Credits Modal -->
    <div class="modal" id="buyCreditsModal">
    <div class="modal-content">
    <span class="modal-close" onclick="closeBuyCredits()">&times;</span>
    <h2>💎 Buy Credits (TEST MODE)</h2>
    <p style="margin-bottom: 20px; color: #666;">Choose a plan - No payment required for testing</p>

    <div class="credit-plans">
    <div class="credit-plan" data-plan="starter" data-credits="25" data-price="9.99">
    <h4>Starter</h4>
    <div class="price">$9.99</div>
    <div class="credits">25 Credits</div>
    <div class="value">$0.40 per credit</div>
    </div>

    <div class="credit-plan" data-plan="popular" data-credits="60" data-price="19.99">
    <h4>Popular</h4>
    <div class="price">$19.99</div>
    <div class="credits">60 Credits</div>
    <div class="value">$0.33 per credit</div>
    </div>

    <div class="credit-plan" data-plan="professional" data-credits="150" data-price="39.99">
    <h4>Professional</h4>
    <div class="price">$39.99</div>
    <div class="credits">150 Credits</div>
    <div class="value">$0.27 per credit</div>
    </div>

    <div class="credit-plan" data-plan="business" data-credits="300" data-price="69.99">
    <h4>Business</h4>
    <div class="price">$69.99</div>
    <div class="credits">300 Credits</div>
    <div class="value">$0.23 per credit</div>
    </div>
    </div>

    <div class="form-group">
    <label for="creditQuantity">Quantity</label>
    <input type="number" id="creditQuantity" min="1" value="1" style="width: 100px;">
    </div>

    <button class="purchase-btn" id="purchaseBtn" onclick="purchaseCredits()" disabled>
    Select a Plan (TEST MODE - No Payment)
    </button>
    <div id="purchaseMessage"></div>
    <div id="stripeCheckout" style="margin-top: 30px;"></div>
    </div>
    </div>
    </div>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
    let currentUser = null;
    let authToken = null;
    let selectedPlan = null;

    // Check if user is already logged in
    document.addEventListener('DOMContentLoaded', function() {
    checkAuthStatus();
    setupEventListeners();
    });

    function setupEventListeners() {
    // File upload handling
    const uploadArea = document.getElementById('uploadArea');
    const imageInput = document.getElementById('imageInput');
    const imagePreview = document.getElementById('imagePreview');
    const form = document.getElementById('imageEditForm');

    uploadArea.addEventListener('click', () => imageInput.click());
    uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
    });
    uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
    imageInput.files = files;
    handleImagePreview(files[0]);
    }
    });

    imageInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
    handleImagePreview(e.target.files[0]);
    }
    });

    // Form submission
    form.addEventListener('submit', generateImageEdit);

    // Credit plan selection
    document.querySelectorAll('.credit-plan').forEach(plan => {
    plan.addEventListener('click', () => selectPlan(plan));
    });

    // Close modal when clicking outside
    document.getElementById('buyCreditsModal').addEventListener('click', (e) => {
    if (e.target.id === 'buyCreditsModal') {
    closeBuyCredits();
    }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
    if (!e.target.closest('.user-menu')) {
    document.getElementById('userDropdown').classList.remove('show');
    }
    });
    }

    async function checkAuthStatus() {
    try {
    const response = await fetch('/api/auth/profile', {
    credentials: 'include'
    });

    if (response.ok) {
    const data = await response.json();
    currentUser = data.user;
    showAuthenticatedState();
    loadUserHistory();
    } else {
    showUnauthenticatedState();
    }
    } catch (error) {
    console.error('Auth check error:', error);
    showUnauthenticatedState();
    }
    }

    function showAuthenticatedState() {
    document.getElementById('authSection').classList.remove('show');
    document.getElementById('userInfo').style.display = 'flex';
    document.getElementById('mainContent').classList.add('show');

    // Update user info
    document.getElementById('creditsCount').textContent = currentUser.credits;
    document.getElementById('dashboardCredits').textContent = currentUser.credits;
    document.getElementById('userAvatar').textContent = currentUser.fullName ? currentUser.fullName[0].toUpperCase() : currentUser.email[0].toUpperCase();
    }

    function showUnauthenticatedState() {
    document.getElementById('authSection').classList.add('show');
    document.getElementById('userInfo').style.display = 'none';
    document.getElementById('mainContent').classList.remove('show');
    document.getElementById('dashboardSection').classList.remove('show');
    }

    function showLogin() {
    document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.auth-tab')[0].classList.add('active');
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('signupForm').style.display = 'none';
    }

    function showSignup() {
    document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.auth-tab')[1].classList.add('active');
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('signupForm').style.display = 'block';
    }

    async function login() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const messageDiv = document.getElementById('loginMessage');

    if (!email || !password) {
    showMessage(messageDiv, 'Please fill in all fields', 'error');
    return;
    }

    try {
    const response = await fetch('/api/auth/login', {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json',
    },
    credentials: 'include',
    body: JSON.stringify({ email, password })
    });

    const data = await response.json();

    if (data.success) {
    currentUser = data.user;
    authToken = data.token;
    showMessage(messageDiv, data.message, 'success');
    setTimeout(() => {
    showAuthenticatedState();
    loadUserHistory();
    }, 1000);
    } else {
    showMessage(messageDiv, data.error, 'error');
    }
    } catch (error) {
    console.error('Login error:', error);
    showMessage(messageDiv, 'Login failed. Please try again.', 'error');
    }
    }

    async function signup() {
    const fullName = document.getElementById('signupName').value;
    const email = document.getElementById('signupEmail').value;
    const password = document.getElementById('signupPassword').value;
    const messageDiv = document.getElementById('signupMessage');

    if (!email || !password) {
    showMessage(messageDiv, 'Email and password are required', 'error');
    return;
    }

    try {
    const response = await fetch('/api/auth/signup', {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json',
    },
    credentials: 'include',
    body: JSON.stringify({ email, password, fullName })
    });

    const data = await response.json();

    if (data.success) {
    currentUser = data.user;
    authToken = data.token;
    showMessage(messageDiv, data.message + ' You received 10 free credits!', 'success');
    setTimeout(() => {
    showAuthenticatedState();
    loadUserHistory();
    }, 1000);
    } else {
    showMessage(messageDiv, data.error, 'error');
    }
    } catch (error) {
    console.error('Signup error:', error);
    showMessage(messageDiv, 'Signup failed. Please try again.', 'error');
    }
    }

    async function logout() {
    try {
    await fetch('/api/auth/logout', {
    method: 'POST',
    credentials: 'include'
    });
    } catch (error) {
    console.error('Logout error:', error);
    }

    currentUser = null;
    authToken = null;
    showUnauthenticatedState();

    // Clear forms
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPassword').value = '';
    document.getElementById('signupName').value = '';
    document.getElementById('signupEmail').value = '';
    document.getElementById('signupPassword').value = '';

    // Clear messages
    document.getElementById('loginMessage').innerHTML = '';
    document.getElementById('signupMessage').innerHTML = '';

    // Reset to login tab
    showLogin();
    }

    function toggleUserMenu() {
    document.getElementById('userDropdown').classList.toggle('show');
    }

    function showDashboard() {
    document.getElementById('userDropdown').classList.remove('show');
    document.getElementById('mainContent').classList.remove('show');
    document.getElementById('dashboardSection').classList.add('show');
    loadUserHistory();
    }

    function showGenerator() {
    document.getElementById('userDropdown').classList.remove('show');
    document.getElementById('dashboardSection').classList.remove('show');
    document.getElementById('mainContent').classList.add('show');
    }

    function showBuyCredits() {
    document.getElementById('userDropdown').classList.remove('show');
    document.getElementById('buyCreditsModal').classList.add('show');
    }

    function closeBuyCredits() {
    document.getElementById('buyCreditsModal').classList.remove('show');
    selectedPlan = null;
    document.querySelectorAll('.credit-plan').forEach(plan => {
    plan.classList.remove('selected');
    });
    document.getElementById('purchaseBtn').textContent = 'Select a Plan';
    document.getElementById('purchaseBtn').disabled = true;
    }

    function selectPlan(planElement) {
    document.querySelectorAll('.credit-plan').forEach(plan => {
    plan.classList.remove('selected');
    });

    planElement.classList.add('selected');
    selectedPlan = {
    name: planElement.dataset.plan,
    credits: parseInt(planElement.dataset.credits),
    price: parseFloat(planElement.dataset.price)
    };

    document.getElementById('purchaseBtn').textContent = `Purchase ${selectedPlan.credits} Credits (TEST MODE)`;
    document.getElementById('purchaseBtn').disabled = false;
    }

    async function purchaseCredits() {
    if (!selectedPlan) return;
    const messageDiv = document.getElementById('purchaseMessage');
    const purchaseBtn = document.getElementById('purchaseBtn');
    const quantity = parseInt(document.getElementById('creditQuantity').value) || 1;
    const totalCredits = selectedPlan.credits * quantity;
    
    purchaseBtn.disabled = true;
    purchaseBtn.textContent = 'Processing...';
    messageDiv.innerHTML = '';
    document.getElementById('stripeCheckout').innerHTML = '';
    
    try {
    const response = await fetch('/api/auth/purchase', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({
    amount: totalCredits,
    plan: selectedPlan.name
    })
    });
    
    const data = await response.json();
    
    if (data.success) {
    // Update user credits
    currentUser.credits = data.newBalance;
    document.getElementById('creditsCount').textContent = currentUser.credits;
    document.getElementById('dashboardCredits').textContent = currentUser.credits;
    
    showMessage(messageDiv, data.message, 'success');
    purchaseBtn.textContent = 'Purchase Complete!';
    
    // Close modal after 2 seconds
    setTimeout(() => {
    closeBuyCredits();
    }, 2000);
    } else {
    showMessage(messageDiv, data.error || 'Failed to purchase credits.', 'error');
    purchaseBtn.disabled = false;
    purchaseBtn.textContent = `Purchase ${selectedPlan.credits} Credits (TEST MODE)`;
    }
    } catch (error) {
    console.error('Purchase error:', error);
    showMessage(messageDiv, 'Purchase failed. Please try again.', 'error');
    purchaseBtn.disabled = false;
    purchaseBtn.textContent = `Purchase ${selectedPlan.credits} Credits (TEST MODE)`;
    }
    }

    function handleImagePreview(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
    document.getElementById('imagePreview').innerHTML = `
    <img src="${e.target.result}" alt="Preview" class="preview-image">
    <p><strong>Selected:</strong> ${file.name}</p>
    `;
    };
    reader.readAsDataURL(file);
    }

    async function generateImageEdit(e) {
    e.preventDefault();

    const imageInput = document.getElementById('imageInput');
    const promptInput = document.getElementById('prompt');
    const generateBtn = document.getElementById('generateBtn');
    const loading = document.getElementById('loading');
    const resultContent = document.getElementById('resultContent');

    if (!imageInput.files[0]) {
    alert('Please select an image first!');
    return;
    }

    if (!promptInput.value.trim()) {
    alert('Please enter an edit prompt!');
    return;
    }

    if (currentUser.credits < 1) {
    alert('Insufficient credits! Please purchase more credits to continue.');
    showBuyCredits();
    return;
    }

    const formData = new FormData();
    formData.append('image', imageInput.files[0]);
    formData.append('prompt', promptInput.value.trim());
    formData.append('outputFormat', document.getElementById('outputFormat').value);

    // Show loading state
    generateBtn.disabled = true;
    generateBtn.textContent = 'Editing...';
    loading.style.display = 'flex';
    resultContent.innerHTML = '';

    try {
    const response = await fetch('/api/auth/generate-image-edit', {
    method: 'POST',
    credentials: 'include',
    body: formData
    });

    const result = await response.json();

    if (result.success) {
    resultContent.innerHTML = `
    <img src="${result.imageUrl}" alt="Edited Image" class="result-image">
    <button class="download-btn" onclick="downloadImage('${result.imageUrl}')">
    Download Edited Image
    </button>
    <div class="success">${result.message}</div>
    `;

    // Update credits
    currentUser.credits = result.creditsRemaining;
    document.getElementById('creditsCount').textContent = currentUser.credits;
    document.getElementById('dashboardCredits').textContent = currentUser.credits;

    // Refresh history if on dashboard
    if (document.getElementById('dashboardSection').classList.contains('show')) {
    loadUserHistory();
    }
    } else {
    resultContent.innerHTML = `
    <div class="error">
    <strong>Error:</strong> ${result.error}
    ${result.details ? `<br><small>${result.details}</small>` : ''}
    </div>
    `;
    }
    } catch (error) {
    resultContent.innerHTML = `
    <div class="error">
    <strong>Network Error:</strong> Failed to connect to the server.
    <br><small>${error.message}</small>
    </div>
    `;
    } finally {
    // Hide loading state
    loading.style.display = 'none';
    generateBtn.disabled = false;
    generateBtn.textContent = 'Edit Image (1 Credit)';
    }
    }

    async function loadUserHistory() {
    try {
    const response = await fetch('/api/auth/history', {
    credentials: 'include'
    });

    if (response.ok) {
    const data = await response.json();
    displayHistory(data.history);
    document.getElementById('totalGenerated').textContent = data.history.length;
    }
    } catch (error) {
    console.error('History load error:', error);
    }
    }

    function displayHistory(history) {
    const historyList = document.getElementById('historyList');

    if (history.length === 0) {
    historyList.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No images edited yet. Start creating!</p>';
    return;
    }

    historyList.innerHTML = history.map(item => `
    <div class="history-item">
    <img src="${item.image_url}" alt="Edited Image" class="history-image">
    <div class="history-details">
    <p class="history-date">${new Date(item.created_at).toLocaleString()}</p>
    <p class="history-params">${formatParams(item.parameters)}</p>
    </div>
    </div>
    `).join('');
    }

    function formatParams(params) {
    if (!params) return '';
    return Object.entries(params)
    .map(([key, value]) => `${key}: ${value}`)
    .join(', ');
    }

    function showMessage(element, message, type) {
    element.innerHTML = `<div class="${type}">${message}</div>`;
    }
    </script>
</body>
</html>